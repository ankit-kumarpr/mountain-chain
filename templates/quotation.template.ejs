<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quotation - <%= quote.quoteId %></title>
    <style>
        /* Your full CSS from the original template should be here */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; font-size: 11px; color: #3f3f46; }
        .page { padding: 40px; }
        h1, h2, h3 { color: #1e293b; margin: 10px 0; }
        .section-header { background-color: #f1f5f9; padding: 10px; border-radius: 5px; margin-top: 20px; font-size: 14px; font-weight: bold; }
        .itinerary-day { border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 10px; }
        ul { padding-left: 20px; }
        li { margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="page">
        <!-- Robust check for nested properties -->
        <h1><%= quote.queryId && quote.queryId.destination ? quote.queryId.destination.name : 'Tour' %> Tour Package</h1>
        <h2>Dear <%= quote.queryId ? quote.queryId.guestName : 'Valued Guest' %>,</h2>
        <p>Greetings from Mountains Chain Travel.</p>
        <hr>
        <h3>Total Price: <%= formatCurrency(quote.summary ? quote.summary.totalSellingPrice : 0) %></h3>
        <hr>
    </div>

    <div class="page">
        <!-- Hotels Section -->
        <div class="section-header">Hotel Details</div>
        <% if (quote.hotelDetails && quote.hotelDetails.entries && quote.hotelDetails.entries.length > 0) { %>
            <ul>
                <% quote.hotelDetails.entries.forEach(entry => { %>
                    <li>
                        <strong><%= entry.hotelName || 'N/A' %></strong> in <%= entry.hotelId ? entry.hotelId.city : 'N/A' %>, <%= entry.hotelId ? entry.hotelId.state : 'N/A' %>
                        <br>
                        <small>Nights: <%= entry.stayNights ? entry.stayNights.join(', ') : 'N/A' %> | Rooms: <%= entry.roomConfig || 'N/A' %> | Meal Plan: <%= entry.mealPlan || 'N/A' %></small>
                    </li>
                <% }); %>
            </ul>
        <% } else { %>
            <p>No hotel details have been provided for this quote.</p>
        <% } %>

        <!-- Itinerary Section -->
        <div class="section-header">Day Wise Itinerary</div>
        <% if (quote.dayWiseItinerary && quote.dayWiseItinerary.length > 0) { %>
            <% quote.dayWiseItinerary.forEach(day => { %>
                <div class="itinerary-day">
                    <strong>Day <%= day.day %>: <%= day.title %></strong>
                    <p><%= day.description %></p>
                </div>
            <% }); %>
        <% } else { %>
            <p>No itinerary has been provided for this quote.</p>
        <% } %>
        
        <!-- Inclusions/Exclusions Section -->
        <div class="section-header">Inclusions & Exclusions</div>
        <% if (quote.inclusionsExclusions && quote.inclusionsExclusions.length > 0) { %>
             <% quote.inclusionsExclusions.forEach(item => { %>
                <h4><%= item.category %></h4>
                <strong>Inclusions:</strong>
                <ul><% if(item.included) { item.included.split('\n').forEach(inc => { %><li><%= inc %></li><% }); } %></ul>
                <strong>Exclusions:</strong>
                <ul><% if(item.excluded) { item.excluded.split('\n').forEach(exc => { %><li><%= exc %></li><% }); } %></ul>
             <% }); %>
        <% } else { %>
            <p>No inclusions or exclusions have been provided.</p>
        <% } %>
    </div>
</body>
</html>